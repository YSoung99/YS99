// script 태그 내에 다음 코드를 추가하세요 (registerEventListeners 함수 내부)

// 탭 전환 기능
tabButtons.forEach(button => {
    button.addEventListener('click', () => {
        // 활성 탭 버튼 변경
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        // 탭 컨텐츠 전환
        const tabId = button.getAttribute('data-tab');
        tabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === `${tabId}-tab`) {
                content.classList.add('active');
            }
        });
    });
});

// 다음 코드도 registerEventListeners 함수에 추가
// 설정 저장 버튼
saveSettingsButton.addEventListener('click', () => {
    API_KEY = apiKeyInput.value.trim();
    selectedModel = modelSelect.value;
    
    // 로컬 스토리지에 설정 저장
    localStorage.setItem('gemini_api_key', API_KEY);
    localStorage.setItem('translator_temperature', temperature);
    localStorage.setItem('translator_top_p', topP);
    localStorage.setItem('translator_model', selectedModel);
    
    alert('설정이 저장되었습니다.');
});

// 다크 모드 토글
themeToggle.addEventListener('change', () => {
    isDarkMode = themeToggle.checked;
    if (isDarkMode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
    localStorage.setItem('translator_dark_mode', isDarkMode);
});

// 지우기 버튼
clearSourceButton.addEventListener('click', () => {
    sourceTextarea.value = '';
    translationResultArea.value = '';
    currentlyDetectedLanguage = null;
});

// 복사 버튼
copyResultButton.addEventListener('click', () => {
    const text = translationResultArea.value;
    if (text) {
        navigator.clipboard.writeText(text)
            .then(() => {
                // 임시 표시 효과
                const originalText = copyResultButton.querySelector('.tooltip-text').textContent;
                copyResultButton.querySelector('.tooltip-text').textContent = '복사됨!';
                setTimeout(() => {
                    copyResultButton.querySelector('.tooltip-text').textContent = originalText;
                }, 1500);
            })
            .catch(err => {
                console.error('텍스트 복사 실패:', err);
            });
    }
});

// 음성 읽기 버튼
speakResultButton.addEventListener('click', () => {
    const text = translationResultArea.value;
    if (text && 'speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        
        // 언어 설정
        const targetLang = targetLanguageSelect.value;
        switch (targetLang) {
            case 'ko':
                utterance.lang = 'ko-KR';
                break;
            case 'en':
                utterance.lang = 'en-US';
                break;
            case 'ja':
                utterance.lang = 'ja-JP';
                break;
            default:
                utterance.lang = 'en-US';
        }
        
        speechSynthesis.speak(utterance);
    }
});

// 번역 기록 지우기
clearHistoryButton.addEventListener('click', () => {
    if (confirm('모든 번역 기록을 지우시겠습니까?')) {
        translationHistory = [];
        localStorage.setItem('translator_history', JSON.stringify(translationHistory));
        renderTranslationHistory();
    }
});

// 다음 함수도 추가해야 합니다 (script 태그 내부, 기존 함수들 외부에)

// 번역 기록 표시 함수
function renderTranslationHistory() {
    if (translationHistory.length === 0) {
        historyList.innerHTML = '<div class="history-empty">번역 기록이 없습니다.</div>';
        return;
    }
    
    historyList.innerHTML = '';
    translationHistory.reverse().forEach((item, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.addEventListener('click', () => {
            // 기록 항목을 클릭하면 번역기로 복원
            sourceLanguageSelect.value = item.sourceLanguage;
            targetLanguageSelect.value = item.targetLanguage;
            sourceTextarea.value = item.sourceText;
            translationResultArea.value = item.translationResult;
            currentlyDetectedLanguage = item.detectedLanguage;
            
            // 번역기 탭으로 전환
            tabButtons.forEach(btn => {
                if (btn.getAttribute('data-tab') === 'translator') {
                    btn.click();
                }
            });
        });
        
        const langNames = {
            'ko': '한국어',
            'en': '영어',
            'ja': '일본어',
            'auto': '자동 감지'
        };
        
        const sourceLangName = item.sourceLanguage === 'auto' && item.detectedLanguage
            ? `자동 감지 (${langNames[item.detectedLanguage] || item.detectedLanguage})`
            : langNames[item.sourceLanguage] || item.sourceLanguage;
        const targetLangName = langNames[item.targetLanguage] || item.targetLanguage;
        
        historyItem.innerHTML = `
            <div class="history-languages">
                <span class="language-badge ${item.sourceLanguage === 'auto' ? 'auto-detect-badge' : ''}">${sourceLangName}</span>
                → 
                <span class="language-badge">${targetLangName}</span>
            </div>
            <div class="history-text">${item.sourceText}</div>
        `;
        
        historyList.appendChild(historyItem);
    });
}

// 번역 함수
async function translateText() {
    const sourceText = sourceTextarea.value.trim();
    const sourceLanguage = sourceLanguageSelect.value;
    const targetLanguage = targetLanguageSelect.value;
    
    if (!sourceText) return;
    if (!API_KEY) {
        errorMessage.textContent = "API 키를 입력해주세요.";
        return;
    }
    
    try {
        errorMessage.textContent = "";
        translationResultArea.value = "번역 중...";
        
        const prompt = `다음 텍스트를 ${sourceLanguage === 'auto' ? '감지된 언어에서' : getLanguageName(sourceLanguage) + '에서'} ${getLanguageName(targetLanguage)}(으)로 번역해주세요. 
번역만 제공하고 다른 설명은 하지 마세요:

${sourceText}`;
        
        const response = await fetch(`${API_URL}${selectedModel}:generateContent?key=${API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }],
                generationConfig: {
                    temperature: temperature,
                    topP: topP
                }
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error.message || "API 오류가 발생했습니다.");
        }
        
        // 응답에서 번역 결과 추출
        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
            const translationResult = data.candidates[0].content.parts[0].text.trim();
            translationResultArea.value = translationResult;
            
            // 감지된 언어 확인 (있을 경우)
            if (data.candidates[0].content.parts[0].citationMetadata && 
                data.candidates[0].content.parts[0].citationMetadata.detectedLanguage) {
                currentlyDetectedLanguage = data.candidates[0].content.parts[0].citationMetadata.detectedLanguage.languageCode;
            }
            
            // 번역 기록에 추가
            const historyItem = {
                sourceLanguage,
                targetLanguage,
                sourceText,
                translationResult,
                detectedLanguage: currentlyDetectedLanguage,
                timestamp: new Date().getTime()
            };
            
            // 중복 항목 제거
            translationHistory = translationHistory.filter(item => 
                item.sourceText !== sourceText || 
                item.targetLanguage !== targetLanguage
            );
            
            // 최대 20개까지 저장
            translationHistory.push(historyItem);
            if (translationHistory.length > 20) {
                translationHistory.shift();
            }
            
            localStorage.setItem('translator_history', JSON.stringify(translationHistory));
            renderTranslationHistory();
        } else {
            throw new Error("응답에서 번역 결과를 찾을 수 없습니다.");
        }
    } catch (error) {
        console.error("번역 오류:", error);
        translationResultArea.value = "";
        errorMessage.textContent = `오류: ${error.message}`;
    }
}

// 언어 이름 반환 함수
function getLanguageName(langCode) {
    const langMap = {
        'ko': '한국어',
        'en': '영어',
        'ja': '일본어'
    };
    return langMap[langCode] || langCode;
}

// 앱 초기화
document.addEventListener('DOMContentLoaded', initializeApp);
